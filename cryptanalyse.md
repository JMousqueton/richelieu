# Challenge Richelieu DGSE - Cryptanalyse

C'est la que les choses commencent à se corser. Accrochez-vous.
Suite à la décompression du fichier zip (cf [Échauffement](./echauffement.md) ), on obtient 6 fichiers :
- .bash_history
- lsb_RGB.png.enc
- motDePasseGPG.txt.enc
- prime.txt
- public.key
- suite.zip

Pour savoir comment s'articulent ces différents fichiers, il faut regarder dans le fichier .bash_history qui est censé garder l'historique des commandes tapées sous linux:
```bash
 1337  gpg -o lsb_RGB.png.enc --symmetric lsb_RGB.png
 1338  vim motDePasseGPG.txt
 1339  openssl genrsa -out priv.key 4096
 1340  openssl rsa -pubout -out public.key -in priv.key
 1341  openssl rsa -noout -text -in priv.key | grep prime1 -A 18 > prime.txt
 1342  sed -i 's/7f/fb/g' prime.txt
 1343  sed -i 's/e1/66/g' prime.txt
 1344  sed -i 's/f4/12/g' prime.txt
 1345  sed -i 's/16/54/g' prime.txt
 1346  sed -i 's/a4/57/g' prime.txt
 1347  sed -i 's/b5/cd/g' prime.txt
 1348  openssl rsautl -encrypt -pubin -inkey public.key -in motDePasseGPG.txt -out motDePasseGPG.txt.enc
```

Le scénario est donc le suivant :
- 1337: Le fichier *lsb_RGB.png* a été chiffré avec [GPG](https://fr.wikipedia.org/wiki/GNU_Privacy_Guard). Ce fichier n'est pas dans l'archive. le fichier chiffré l'est par contre, il s'agit de *lsb_RGB.png.enc*
- 1338: Le mot de passe utilisé dans le chiffrement est stocké dans le fichier *motDePasseGPG.txt*
- 1339: Une clé privé [RSA](https://fr.wikipedia.org/wiki/Chiffrement_RSA) de 4096 bits est générée. Pour info une clé de 2048 bits est jugée suffisante par L'[ANSSI](https://fr.wikipedia.org/wiki/Agence_nationale_de_la_s%C3%A9curit%C3%A9_des_syst%C3%A8mes_d%27information) jusqu'en 2030. Peu de chance qu'on casse cette clé directement avec la puissance de calcul d'un simple pc. Heureusement, une partie de cette clé privée nous est accessible (cf. plus bas), ce qui va nous permettre de résoudre cette partie du challenge. Cette clé privée n'est évidement pas dans l'archive.
- 1340: La clé publique associée est extraite ensuite. Cette clé est dans l'archive : il s'agit du fichier *public.key*.
- 1341: Heureusement pour nous, une partie de la clé privée est extraite : il s'agit d'un des deux nombre à factoriser. RSA repose sur la difficulté de factoriser un nombre n, qui est le facteur de deux nombres premiers : p et q. n est contenu dans la clé publique. Il nous est donc connu. p est contenu dans le fichier prime.txt.
- 1342-1347: Une succession de commande sed vient augmenter la difficulté du challenge : certains octets du nombre premier p sont modifiés.
- 1348: Le fichier *motDePasseGPG.txt* est chiffré avec RSA. Le résultat est stocké dans le fichier *motDePasseGPG.txt.enc*, présent dans l'archive.

Essayons donc de réaliser l'opération inverse et de retrouver le fichier *lsb_RGB.png*.

1. Extraction des entiers de la clé public
```bash
grep -v -- ----- public.key | base64 -d | openssl asn1parse -inform DER -i -strparse 19
    0:d=0  hl=4 l= 522 cons: SEQUENCE          
    4:d=1  hl=4 l= 513 prim:  INTEGER           :CD5F8A24C7605008897A3C922C0E812E769DE0A46442C350CB78C7868539F3D38AAC80B3E6A506605910E8599806B4D1D148F2F6B81DA04796A8A5AEE18F29E83E16775A2A0A00870541F6574ED1438636AE0A0C116E07104F48F72094863A3869E1C8FC220627278962FB22873E3156F18E55DEC94E970064EC7F4E0E88454012E2FD5DFE5F8D19BF170F9CCB3F46E0FD1019BCB02D9083A0703C617F996379E6478354A73AE6E6ACBCE1F4333ECFAF24366A3E977D3CD3CBFE8D8A387BD876BFDAB8488F6F47BF1FBE33010FD2D7E22B4DB2E567783CE0B606DB86B93759714C4F6396A7FB9F74C4021043B0F3D46D2633EBD43A877863DF7D680F506587C119DD64100CA831CE2AF33D951B524C5F06B49F5BF2CB381E74181930D06A80505C06ABD5BF4870F0C9FB581BD80DBA889660639F936EDEA8FE5D0C9EAE58062ED693252583C71CC782BA613E01438E69B43F9E64ECA84F9EA04E811AD7B39EFD7876D1B6B501C4F48ACCE6F24239F6C04028788135CD88C3D15BE0F2EBB7DE9E9C19A7A93037005EE0A9A640BADA332EC0D05EE9F08A832354A0487A927D5E88066E2569E6C5D4688E422BFA0B27C6171C6D7BF029BFD9165752AF19AA71B33A1EA70B6C371FB21E47F527D80B7D04F582AD9F9935AF723682DC01CA9880621870DECB7AD15648CDF4EF153016F3E6D87933B8EC54CFA1FDF87C467020A3E753
  521:d=1  hl=2 l=   3 prim:  INTEGER           :010001
```

On a donc n = 0xCD5F8A24C7605008897A3C922C0E812E769DE0A46442C350CB78C7868539F3D38AAC80B3E6A506605910E8599806B4D1D148F2F6B81DA04796A8A5AEE18F29E83E16775A2A0A00870541F6574ED1438636AE0A0C116E07104F48F72094863A3869E1C8FC220627278962FB22873E3156F18E55DEC94E970064EC7F4E0E88454012E2FD5DFE5F8D19BF170F9CCB3F46E0FD1019BCB02D9083A0703C617F996379E6478354A73AE6E6ACBCE1F4333ECFAF24366A3E977D3CD3CBFE8D8A387BD876BFDAB8488F6F47BF1FBE33010FD2D7E22B4DB2E567783CE0B606DB86B93759714C4F6396A7FB9F74C4021043B0F3D46D2633EBD43A877863DF7D680F506587C119DD64100CA831CE2AF33D951B524C5F06B49F5BF2CB381E74181930D06A80505C06ABD5BF4870F0C9FB581BD80DBA889660639F936EDEA8FE5D0C9EAE58062ED693252583C71CC782BA613E01438E69B43F9E64ECA84F9EA04E811AD7B39EFD7876D1B6B501C4F48ACCE6F24239F6C04028788135CD88C3D15BE0F2EBB7DE9E9C19A7A93037005EE0A9A640BADA332EC0D05EE9F08A832354A0487A927D5E88066E2569E6C5D4688E422BFA0B27C6171C6D7BF029BFD9165752AF19AA71B33A1EA70B6C371FB21E47F527D80B7D04F582AD9F9935AF723682DC01CA9880621870DECB7AD15648CDF4EF153016F3E6D87933B8EC54CFA1FDF87C467020A3E753

Et e = 0x10001

Je vous invite à consulter [la page Wikipédia de RSA](https://fr.wikipedia.org/wiki/Chiffrement_RSA#Fonctionnement_d%C3%A9taill%C3%A9), si vous ne voyez pas ce que signifient ces chiffres.


2. Reconstitution de l'entier p
On essaye tout d'abord d'effectuer les opérations inverses des sed, soit:
```bash
cp prime.txt prime.bck
sed -i 's/fb/7f/g' prime.txt
sed -i 's/66/e1/g' prime.txt
sed -i 's/12/f4/g' prime.txt
sed -i 's/54/16/g' prime.txt
sed -i 's/57/a4/g' prime.txt
sed -i 's/cd/b5/g' prime.txt
```
On obtient :
```
prime1:
    00:7f:40:dc:44:ba:03:d1:53:42:f7:59:08:e0:f9:
    30:05:96:64:4a:de:94:68:5e:08:e2:8c:9a:b1:64:
    0c:2f:62:c2:9a:b9:a2:39:82:4b:9e:be:eb:76:ae:
    6d:87:21:a3:5e:9e:d9:8d:7e:a4:38:3e:59:09:34:
    a5:78:b5:f7:2e:89:5d:5c:37:52:ea:fd:f6:31:cc:
    ba:d2:d9:60:e4:45:1d:67:76:d2:1f:f4:9c:9d:c9:
    b1:90:45:51:ed:d2:7f:dd:b6:74:b4:99:7f:b1:0a:
    d9:b7:c2:be:8b:a4:07:22:0a:8e:3a:36:ff:6d:c1:
    1d:63:93:af:cb:4e:c0:47:9f:65:bf:df:e3:f0:5f:
    1e:98:61:45:74:ec:36:a7:a5:b1:f1:8d:3d:97:6b:
    5a:82:49:09:00:08:0d:9d:c2:74:a4:4e:30:a1:39:
    68:2f:22:34:71:13:aa:3b:f2:20:4f:8e:10:eb:d4:
    d0:9b:b5:8c:c2:53:5f:9d:71:13:0c:0f:21:b6:6e:
    13:39:40:d3:a6:b1:eb:74:ad:dd:0a:29:14:81:b1:
    90:ad:e0:53:f0:89:c8:00:fe:dc:ad:56:59:fc:28:
    1d:c0:cf:5e:08:c0:16:33:24:a3:52:bb:f3:25:10:
    43:c3:73:b8:40:4f:fc:6b:6b:77:bd:5f:22:24:eb:
    7f:15
```

Lançons une console python pour essayer d'obtenir l'entier q:
```python
>>> p = int("".join(open("prime.txt").read().replace("\n","").replace(" ","").split(":")[2:]),16)
>>> n = 0xCD5F8A24C7605008897A3C922C0E812E769DE0A46442C350CB78C7868539F3D38AAC80B3E6A506605910E8599806B4D1D148F2F6B81DA04796A8A5AEE18F29E83E16775A2A0A00870541F6574ED1438636AE0A0C116E07104F48F72094863A3869E1C8FC220627278962FB22873E3156F18E55DEC94E970064EC7F4E0E88454012E2FD5DFE5F8D19BF170F9CCB3F46E0FD1019BCB02D9083A0703C617F996379E6478354A73AE6E6ACBCE1F4333ECFAF24366A3E977D3CD3CBFE8D8A387BD876BFDAB8488F6F47BF1FBE33010FD2D7E22B4DB2E567783CE0B606DB86B93759714C4F6396A7FB9F74C4021043B0F3D46D2633EBD43A877863DF7D680F506587C119DD64100CA831CE2AF33D951B524C5F06B49F5BF2CB381E74181930D06A80505C06ABD5BF4870F0C9FB581BD80DBA889660639F936EDEA8FE5D0C9EAE58062ED693252583C71CC782BA613E01438E69B43F9E64ECA84F9EA04E811AD7B39EFD7876D1B6B501C4F48ACCE6F24239F6C04028788135CD88C3D15BE0F2EBB7DE9E9C19A7A93037005EE0A9A640BADA332EC0D05EE9F08A832354A0487A927D5E88066E2569E6C5D4688E422BFA0B27C6171C6D7BF029BFD9165752AF19AA71B33A1EA70B6C371FB21E47F527D80B7D04F582AD9F9935AF723682DC01CA9880621870DECB7AD15648CDF4EF153016F3E6D87933B8EC54CFA1FDF87C467020A3E753
>>> q = n/p
>>> n == p * q
False
```

Mince ! Quelque-chose cloche... Il semblerait que l'entier n ne soit pas divisible par p... C'est donc que mon p est faux. Il est faux car les sed ne sont pas bijectifs : Il se peut très bien qu'un des octets remplaçables (0xfb, 0x66, 0x12, 0x54x 0x57 et 0xcd) ait été présent avant les sed. Auquel cas il ne faut pas les re-modifier dans l'autre sens. Mais comment savoir lesquels ? On n'a pas le choix, il faut bruteforcer toutes les combinaisons possibles de ces octets.

J'ai pour ça réalisé un [petit script python](./scripts/bruteforceRsaPrime.py). Il s’exécute en 200ms sur ma machine malgré le bruteforcing.

```bash
python3 bruteforceRsaPrime.py
n = 837849563862443268467145186974119695264713699736869090645354954749227901572347301978135797019317859500555501198030540582269024532041297110543579716921121054608494680063992435808708593796476251796064060074170458193997424535149535571009862661106986816844991748325991752241516736019840401840150280563780565210071876568736454876944081872530701199426927496904961840225828224638335830986649773182889291953429581550269688392460126500500241969200245489815778699333733762961281550873031692933566002822719129034336264975002130651771127313980758562909726233111335221426610990708111420561543408517386750898610535272480495075060087676747037430993946235792405851007090987857400336566798760095401096997696558611588264303087788673650321049503980655866936279251406742641888332665054505305697841899685165810087938256696223326430000379461379116517951965921710056451210314300437093481577578273495492184643002539393573651797054497188546381723478952017972346925020598375000908655964982541016719356586602781209943943317644547996232516630476025321795055805235006790200867328602560320883328523659710885314500874028671969578391146701739515500370268679301080577468316159102141953941314919039404470348112690214065442074200255579004452618002777227561755664967507
e = 65537
p = 31717798413454838971739311391870214101486054474438584033384974797696836002786889741922328038249283935148167589396475764515984792248325276562635675483085593307632384945480084324354199386711259069590701728377654610059849152461565385315663116675949927841648944186909571007960100266136674008112969369512988507367569334838093403144731951113528040013763615354283491955226704334394856253005551393545293491547587439064269735583121706098798182168292621767902095641352443871167789104818694502605762517497996162527138366803593402358312011933528177646501311411008602369245268966975849244259437732574655956250792264392115994984213
q = 26415754111957012456882978698568998595543408604540679602012008905307229528398419508696699258861541673208334031720118065722015191735056250991124159829757615035331104814626815428071461389740988358621575175288995137250131479702118666935818278843603742157096854979085966659730153703721295913600711482578441198179188796849780101926878867272222747848775311501107737838687624647749187764563156054858429897018261077616060929102880860789449995240869652963349913062375402021334173237153511868665597034141167420444312865576543827395764456254276820652449103574192677537410783040227047254038577626347718324544296319787177388746439
d = 118370525227007068110186570733988041235576607807248896200395830233655814893241431084968175909819858417621242742154275832754457758856376855005920389993021649520424374669461616539555256877207891959957842626710778223266584582311511815493237688316364663276741056162936320460262194772536159431129765594092562266811961260813446384570933275214943656339074441824359395130246174404174000322037783998357751410604765179577140315024921971834715357627371911900213543145567250732540486740824273995939509286899864438850107228032176140268075557321022377191222594753770432201489100248201834734262026328066343082079358928359505377114924600461388021808147620175136768509457156427255160402062797794394199344781103672831290074439566751529983822098164980856581615999161891764310600269017166628918150345568093145105764852306653652447892885569706573841179397009260568259791565586868967165347947112010266100894829126306333574904005075277465193718571710380290644054431964779997554766021644649946133285410890067888020496324509852566219796399390364634306685384993869571442872586796766292465661785739009215588267511837697073523883029574481272539225104150953522658292050983386115413770734896974806099459808154373214219593317955386998794014437737295712013339975465
décrypté : b'\x02y\xd4_\xb8U\xee\r\xadrf\xf9xd\x8c\xba\xa4\xd5\x13\x13\xde\xa0\xe2cczO.\xb6P\xc5\xb2:7O\xe7\xdc\xa6\xfc[T\x14\x9b\xda\xe7\xf3\xe1P\xd9\x88\x11\xfap\xdeX\xf2L \xd4\xbbL\xb8aG3\xbe\xe6C.\xf8a\x84\xbe\xd5@\x19\x9b\x8f\x16\xa7\xd4\x1d\xb9\xee\x12\\"U\xa1]\x0bj\\p\x8b\xcf\x07\x98Hb/\xeaY\xb4\xd6\xe1\x16\xf3\xc8\x1dm\x19\xd8\xc6r\xc0\xc3N\x0e\x91iy.\x15\x10\x0e\xee\x0b\xfe\xc5\xc8o\xbf\x97\x1c\xc4\xfc\xc9\xa1;\xf2P~\x8f\xc5\xbe\x11$\x959@\xb5\x91{\r\xb7\xbc\xda\x04\xddI\tK\xce\xcf=\xe6\xf3\xbb8\x82\x98z/\x97S\xfe\x9c\xc2\x82\t\xa9\x83\xc9\x058\xb4\xd7\xbd\xdd\xfco\x84\x84\x83}\x91YO\x89\xa2\xc5\xcb\xc1\xa65\xd6\x16\x1a\xe9_{yC\x03\xda\xda\x0b\xbc\xda\xc1\x815R\x8b\xcf(}>\xb7KF\x15\xe2\x8aI\x1c\xe2\xb8\xa0\x1e\xae\xa7\x19Qhn~\xb9x\x07\xb8\x13\xf5R\x83\x19\xaf\x05C@\xc0\xcb\xc1\x03\x89T^\r\x04\n\xfa\xa6\xe8\xc2H\xe9\xc3\xae\xe2\xc8\xd6\x87\xa2a\xd3\x1cDN\x9d\xe3\xb0\x8c\x12`\'BY\xd3\'M\x03\xcc\xbc~\t\xea I\xc3\xa7\n\xb0\x9bTg1o\xb7\x1a\x02\xe0\xe3D\xb1\xba\x11\x91a\x99\x1bm\xd4x`\x88\x01\x17Coy\x0e=\x89\x9fb\xf2\xf3\xfax\xee?\xa5\xef\\\xb0\x98\xc8\x0bM\xab\x8c\xda^W0\xcbA\xa8h\r\x0c\xe4\xcf\x1e\xd3\xdaO%\xd5\xd3\x19\xf1\x1b\x0fb\xbf\xb4\xeek\x19c@-;\xbet@\xa5:\xf5\xb0\xc6{\x80\xf0C\x1b\x87\xb5\xd1\x0e\xbf\'\x83(\x14\xb9p\x93\xd02(Zk\xcc\xf9\xf7#_\xec\x98:s\xe9!\xa1\x9e\x81\x06\xb6\x1c\xf2\x85\xd901B\x99\x1by\xe2\xf8\xfd\xd0\x0e\x10n\xc5\xdf\x1f\xa5\x84\x00DGSE{Ti,%yei3=stlh_,5@pIrrMU.^mJC:luYbt1Qe_-Y}\n'
```
Les caractères au début constituent le padding, il faut les ignorer. On obtient la clé gpg : **DGSE{Ti,%yei3=stlh_,5@pIrrMU.^mJC:luYbt1Qe_-Y}**

Enfin on déchiffre le fichier *lsb_RGB.png.enc* à l'aide de cette clé :

```bash
gpg --output lsb_RGB.png --decrypt lsb_RGB.png.enc
gpg: données chiffrées avec AES256
gpg: chiffré avec 1 phrase secrète
```
On obtient le fichier [lsb_RGB.png](./images/lsb_RGB.png).
Il sera traité dans la section suivante : [Stéganographie](./steganographie.md)
